# Arc風タブ自動アーカイブChrome拡張機能 仕様書

## 1. 概要

本拡張機能は、Google Chromeブラウザにおいて、非アクティブなタブを自動的に閉じ（アーカイブし）、タブの表示順序を整理することで、ユーザーのブラウジング体験を向上させることを目的とします。特に、ピン留めされていないタブや特定のグループに属していないタブを管理対象とします。

## 2. 主な機能

1.  **タブの自動アーカイブ機能:**
    - 最後にアクティブになってから一定時間が経過したタブを自動的に閉じます。
    - ピン留めされたタブ、およびタブグループに属するタブはアーカイブ対象外とします。
2.  **タブの並び替え機能:**
    - タブグループに属していない通常のタブを、常に全てのタブグループの後ろに配置します。

## 3. 機能詳細

### 3.1. タブの自動アーカイブ機能

#### 3.1.1. アーカイブ対象タブ

- 以下の条件を**すべて**満たすタブをアーカイブ対象とします。
    - ピン留めされていない。
    - どのタブグループにも属していない。
    - 最後にアクティブになってから、設定されたアーカイブ時間を経過している。
        - 「最後にアクティブになった時間」とは、そのタブがユーザーによって選択され、表示された最後の時刻を指します。新しいタブが開かれた場合、そのタブは作成時にアクティブとみなされます。
        - バックグラウンドで開かれたタブ（例: `Ctrl`キーを押しながらリンクをクリック）は、ユーザーが明示的にそのタブを選択するまでアクティブとはみなされません。

#### 3.1.2. アーカイブ時間

- **デフォルト値:** 12時間
- ユーザーは拡張機能の設定画面から、アーカイブまでの時間を分単位または時間単位で設定変更可能です。
    - 設定可能な最小値: 1分
    - 設定可能な最大値: 72時間 (3日間)

#### 3.1.3. アーカイブ処理

- アーカイブ対象となったタブは、自動的に閉じられます。
- アーカイブ処理実行時にユーザーへの通知は行いません（将来的にオプションで通知機能を追加する可能性あり）。

#### 3.1.4. アーカイブ処理のトリガーとタイミング

- 拡張機能は、バックグラウンドで定期的に（例: 1分ごと）全ての開いているタブの状態を確認し、アーカイブ条件に合致するタブがないかチェックします。
- ブラウザ起動時にも一度、全てのタブの状態を確認します。
- タブがアクティブでなくなった（別のタブに切り替わった、新しいタブが開かれたなど）時点で、そのタブの非アクティブタイマーを開始します。
- タブが再度アクティブになった場合、そのタブの非アクティブタイマーはリセットされます。

#### 3.1.5. アーカイブ対象外への変更時の挙動

- アーカイブタイマーが作動中のタブが以下の状態になった場合、そのタブのアーカイブタイマーはキャンセルされ、アーカイブ対象外となります。
    - ピン留めされた場合。
    - タブグループに追加された場合。

#### 3.1.6. アーカイブ対象への変更時の挙動

- ピン留めされていたタブがピン留め解除された場合、またはタブグループに属していたタブがグループから出された場合、その時点から非アクティブタイマーが開始されます（そのタブがアクティブでない場合）。

#### 3.1.7. シークレットウィンドウでの挙動

- デフォルトでは、シークレットウィンドウ内のタブは本機能の対象外とします。
- ユーザーは拡張機能の設定画面から、シークレットウィンドウでも本機能を有効にするか選択できます。

### 3.2. タブの並び替え機能

#### 3.2.1. 並び替え対象タブ

- どのタブグループにも属していない通常のタブ。
- ピン留めされたタブは並び替えの対象外とし、常にタブバーの先頭に表示されるChromeの標準動作に従います。

#### 3.2.2. 並び替えルール

- 並び替え対象タブは、常に全てのタブグループの後ろ（右側）に配置されます。
- 複数の並び替え対象タブが存在する場合、それらのタブ間の相対的な順序は維持されます（最後にアクティブになった順、または開いた順など、Chromeのデフォルトの挙動に準じます）。

#### 3.2.3. 並び替え処理のトリガーとタイミング

- 以下のイベント発生時に、タブの並び替え処理が実行されます。
    - 新しいタブが作成された時（それがグループに属さない場合）。
    - タブがタブグループから出された時。
    - タブがタブグループに追加された時（これにより他のタブの相対位置が変わる可能性があるため）。
    - タブがユーザーによって手動で移動された時（移動先がルールに反する場合、即座に再配置）。
    - タブグループが作成された時。
    - タブグループが閉じられた（グループ解除された）時。
    - 拡張機能が有効化された時、またはブラウザ起動時。

#### 3.2.4. ユーザーによる手動移動への対応

- ユーザーがグループに属さないタブをタブグループの間や先頭（ピン留めタブを除く）にドラッグ＆ドロップで移動しようとした場合、移動操作完了直後に、本機能による並び替えルールに基づき、自動的に正しい位置（全てのタブグループの後ろ）に再配置されます。

### 3.3. 複数ウィンドウでの挙動

- 本拡張機能の各機能（自動アーカイブ、並び替え）は、開いている各Chromeウィンドウに対して独立して動作します。
    - あるウィンドウのタブの非アクティブ時間は、他のウィンドウのタブの非アクティブ時間やアクティビティに影響を与えません。
    - タブの並び替えもウィンドウごとに適用されます。

## 4. 設定画面 (ポップアップUI)

拡張機能アイコンをクリックすると表示されるポップアップ画面で、以下の設定が可能です。

- **自動アーカイブ機能のON/OFFスイッチ:**
    - デフォルト: ON
- **アーカイブ時間の設定:**
    - 数値入力フィールドと単位選択（分/時間）。
    - 入力値のバリデーション（3.1.2.参照）。
- **シークレットウィンドウでの動作設定:**
    - チェックボックス「シークレットウィンドウでも有効にする」。
    - デフォルト: OFF
- **タブの並び替え機能のON/OFFスイッチ:**
    - デフォルト: ON

## 5. 技術仕様（推奨）

- **使用するChrome API:**
    - `chrome.tabs`: タブ情報の取得、タブの操作（閉じる、移動する）、タブイベントの監視（作成、更新、移動、アクティブ化など）。
    - `chrome.storage.local` または `chrome.storage.sync`: ユーザー設定の保存。`sync` を使用する場合は、保存容量制限に注意。
    - `chrome.alarms`: 定期的なアーカイブ処理のスケジューリング。
    - `chrome.tabGroups`: タブグループ情報の取得、タブグループイベントの監視。
    - `chrome.windows`: ウィンドウ情報の取得、ウィンドウイベントの監視。
- **データ保存:**
    - ユーザー設定（アーカイブ時間、ON/OFF状態など）は `chrome.storage` API を使用して永続化します。
    - 各タブの最終アクティブ時刻は、拡張機能の実行時メモリ（JavaScriptオブジェクトなど）で管理し、必要に応じて `chrome.storage.session` (MV3の場合) または `chrome.storage.local` に一時保存することを検討します。`chrome.storage.session` はブラウザセッション中のみデータを保持します。

## 6. その他

### 6.1. エラーハンドリング

- Chrome API呼び出し時に発生しうるエラー（権限不足、存在しないタブIDへのアクセスなど）を適切に処理し、拡張機能がクラッシュしないようにします。
- エラーが発生した場合、開発者コンソールにエラーメッセージを出力します。

### 6.2. パフォーマンス考慮事項

- タブイベントの監視や定期的な処理は、ブラウザのパフォーマンスに影響を与えないよう、効率的に実装します。
- 特に多数のタブが開かれている場合の処理負荷に注意します。
- 不要なAPI呼び出しを避け、処理を最小限に抑えます。

### 6.3. 権限

- `manifest.json` で要求する権限は、機能実現に必要な最小限のものとします。
    - `tabs`: タブ情報へのアクセスと操作。
    - `storage`: 設定の保存。
    - `alarms`: 定期処理のスケジューリング。
    - `tabGroups`: タブグループ情報へのアクセス。 (MV3では `tabs` 権限に含まれる場合があるか要確認)
